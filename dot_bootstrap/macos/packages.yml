---
- name: Install packages on macOS
  hosts: localhost
  become: false

  vars:
    brew_packages:
      - chezmoi
      - atuin
      - temurin
      - btop
      - android-commandlinetools
      - cocoapods
      - flutter
      - neovim
      - atuin
      - yazi
      - fzf
      - lazygit
      - wireguard-tools
      - fd
      - mas
      - podman
      - podman-compose
      - koekeishiya/formulae/yabai
      - koekeishiya/formulae/skhd
    cask_packages:
      - dbeaver-community
      - keymapp
      - karabiner-elements
      - podman-desktop
      - localsend
      - obsidian
      - bitwarden
      - raycast
      - mullvad-browser
      - devcleaner
      - gimp
      - inkscape
      - kitty
      - localsend
      - font-fira-code-nerd-font

  tasks:
    - name: Ensure koekeishiya tap is added
      shell: brew tap koekeishiya/formulae

    - name: Install Homebrew packages
      homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ brew_packages }}"

    - name: Install Homebrew cask packages
      homebrew_cask:
        name: "{{ item }}"
        state: present
      loop: "{{ cask_packages }}"

    - name: Remove quarantine attribute from cask apps
      become: true
      shell: sudo xattr -d com.apple.quarantine /Applications/{{ item | title }}.app || true
      loop: "{{ cask_packages }}"
      ignore_errors: true

    - name: Start yabai service
      shell: yabai --start-service

    - name: Start skhd service
      shell: skhd --start-service

    - name: Install Oh My Zsh
      shell: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
      args:
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
      environment:
        RUNZSH: "no"
        CHSH: "no"

    - name: Install Xcode
      shell: mas install 497799835
