- hosts: localhost
  become: false
  gather_facts: yes

  vars:
    brew_packages:
      - chezmoi
      - atuin
      - temurin
      - php
      - btop
      - composer
      - android-commandlinetools
      - cocoapods
      - flutter
      - rustup
      - node
      - neovim
      - atuin
      - yazi
      - fzf
      - lazygit
      - fd
      - mas
      - podman
      - podman-compose
      - koekeishiya/formulae/yabai
      - koekeishiya/formulae/skhd
    cask_packages:
      - dbeaver-community
      - keymapp
      - karabiner-elements
      - podman-desktop
      - obsidian
      - firefox
      - bitwarden
      - raycast
      - devcleaner
      - parallels
      - gimp
      - inkscape
      - kitty
      - libreoffice
      - font-0xproto-nerd-font
    ssh_key_path: "{{ ansible_env.HOME }}/Library/Mobile Documents/com~apple~CloudDocs/.ssh/id_ed25519"

  tasks:
    - name: Ensure koekeishiya tap is added
      shell: brew tap koekeishiya/formulae

    - name: Ensure slp tap is added
      shell: brew tap slp/krunkit

    - name: Install Homebrew packages
      homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ brew_packages }}"

    - name: Install Homebrew cask packages
      homebrew_cask:
        name: "{{ item }}"
        state: present
      loop: "{{ cask_packages }}"

    - name: Remove quarantine attribute from cask apps
      become: true
      shell: sudo xattr -d com.apple.quarantine /Applications/{{ item | title }}.app || true
      loop: "{{ cask_packages }}"
      ignore_errors: true

    - name: Start yabai service
      shell: yabai --start-service

    - name: Start skhd service
      shell: skhd --start-service

    - name: Install Oh My Zsh
      shell: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
      args:
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
      environment:
        RUNZSH: "no"
        CHSH: "no"

    - name: Install Xcode
      shell: mas install 497799835
      environment:
        RUNZSH: "no"
        CHSH: "no"

    - name: Install Wireguard
      shell: mas install 1451685025
      environment:
        RUNZSH: "no"
        CHSH: "no"
