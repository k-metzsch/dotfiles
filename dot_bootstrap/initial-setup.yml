---
- hosts: localhost
  become: false
  gather_facts: yes
  vars:
    brew_packages:
      - chezmoi
      - autin
      - temurin
      - pyenv
      - php
      - btop
      - composer
      - android-commandlinetools
      - cocoapods
      - flutter
      - rustup
      - node
      - neovim
      - lazygit
      - fzf
      - atuin
      - k9s
      - yazi
      - docker-compose
      - lazydocker
      - mas
      - firebase-cli
      - koekeishiya/formulae/yabai
      - koekeishiya/formulae/skhd
    cask_packages:
      - dbeaver-community
      - karabiner-elements
      - obsidian
      - figma
      - docker
      - devcleaner
      - gimp
      - inkscape
      - alacritty
      - onlyoffice
      - font-0xproto-nerd-font

  tasks:
    - name: Ensure koekeishiya tap is added
      shell: brew tap koekeishiya/formulae
      args:
        creates: /opt/homebrew/Library/Taps/koekeishiya/homebrew-formulae

    - name: Install Homebrew packages
      homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ brew_packages }}"

    - name: Install Homebrew cask packages
      homebrew_cask:
        name: "{{ item }}"
        state: present
      loop: "{{ cask_packages }}"

    - name: Remove quarantine attribute from cask apps
      become: true
      shell: sudo xattr -d com.apple.quarantine /Applications/{{ item | title }}.app || true
      loop: "{{ cask_packages }}"
      ignore_errors: true

    - name: Start Colima (Docker-compatible daemon)
      shell: colima start
      args:
        executable: /bin/bash
      register: colima_started
      changed_when: false

    - name: Start yabai service
      shell: yabai --start-service

    - name: Start skhd service
      shell: skhd --start-service

    - name: Install Oh My Zsh
      shell: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

    - name: Install Xcode
      shell: |
        if ! mas list | grep -i "Xcode"; then
          mas install 497799835
        fi
      args:
        executable: /bin/bash
      when: mas_installed.rc == 0
      register: xcode_install

    - name: Add iCloud SSH key 'github' to ssh agent with keychain support
      shell: ssh-add --apple-use-keychain ~/Library/Mobile\ Documents/com~apple~CloudDocs/.ssh/github
      args:
        creates: ~/Library/Mobile\ Documents/com~apple~CloudDocs/.ssh/github
